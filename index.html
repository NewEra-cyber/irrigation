<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Irrigation Scheme Monitoring</title>
  <!-- Chart.js for pie chart rendering -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Preserve your original styles */
    body {
      font-family: 'Times New Roman', serif;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #ffffff;
      overflow-x: hidden;
      transition: background-image 1s ease-in-out;
    }
    body.login-active::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(52, 199, 89, 0.3);
      z-index: -1;
    }
    body.dashboard-active::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: -1;
    }
    /* Login Section */
    .login-section {
      display: none;
      text-align: center;
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }
    .login-section.active { display: block; }
    .login-box {
      background: #2d2d39;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
      padding: 20px;
      position: relative;
    }
    .login-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #00ccff, #ff00cc);
      filter: drop-shadow(15px 50px 10px #080);
      animation: rotating 4s linear infinite;
      z-index: -1;
    }
    .login-box::after {
      content: '';
      position: absolute;
      inset: 4px;
      background: #2d2d39;
      border-radius: 15px;
      z-index: -1;
    }
    @keyframes rotating { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .login-header { margin: 20px 0; text-align: center; }
    .login-header h2 { font-weight: bold; color: rgb(47,241,8); text-shadow: 0 0 10px #080808, 0 0 20px #1e1b1e, 0 0 30px #e40c45; margin: 0; }
    .heart { font-size: 20px; background: linear-gradient(45deg, #f23708, #09f3112c); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-right: 10px; }
    .description { margin: 10px 0 20px; color: #139ef4; font-size: 16px; text-align: center; }
    .form-group { margin: 0 20px 20px 20px; position: relative; }
    .form-group label { display: block; color: white; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 10px; background: transparent; border: 1px solid white; border-radius: 5px; color: white; box-sizing: border-box; }
    .form-group input::placeholder { color: #b0b0b0; }
    .toggle-password {
      position: absolute; right: 10px; top: 40px; cursor: pointer; font-size: 12px; color: #fff; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 5px;
    }
    .buttons { display: flex; justify-content: space-between; gap: 10px; margin: 0 20px; }
    .buttons button { flex: 1; padding: 10px 20px; border: none; border-radius: 20px; font-weight: bold; text-transform: uppercase; cursor: pointer; }
    .signin-button { background: url('pictures/pexels-souvenirpixels-417074.jpg') no-repeat center center; background-size: cover; color: white; }
    .signup-button { background: url('pictures/pexels-souvenirpixels-417074.jpg') no-repeat center center; background-size: cover; color: white; }
    .google-button {
      background: #000; color: #fff; padding: 10px; border: none; border-radius: 5px; cursor: pointer;
      width: 100%; display: flex; align-items: center; justify-content: center; margin-top: 10px;
    }
    .google-button .google-icon { width: 20px; height: 20px; margin-right: 8px; }
    .links { display: flex; justify-content: space-between; margin: 20px 20px 0; }
    .links a { color: #b0b0b0; text-decoration: none; font-size: 12px; }
    .links a:hover { text-decoration: underline; }
    .error-message { color: #ff4444; font-size: 12px; text-align: center; margin-top: 10px; }
    .hidden { display: none; }
    .form-toggle { margin: 10px 0; cursor: pointer; color: #00ccff; text-decoration: underline; }
    /* New fields for role selection in registration */
    .form-group select, .form-group input.secret-key {
      width: 100%; padding: 10px; background: transparent; border: 1px solid white; border-radius: 5px; color: white; margin-top: 5px;
    }
    /* Dashboard Section Styles (unchanged) */
    .dashboard-section { display: none; width: 100%; }
    .dashboard-section.active { display: block; }
    .sidebar {
      position: fixed; top: 0; left: -300px; width: 300px; height: 100%;
      background: url('pictures/pexels-tdcat-347729.jpg') no-repeat center center; background-size: cover;
      filter: brightness(80%); transition: left 1s ease; z-index: 1000; padding-top: 20px;
    }
    .sidebar.active { left: 0; }
    .hamburger { position: fixed; top: 20px; left: 20px; font-size: 24px; color: #fff; cursor: pointer; z-index: 1001; }
    .hamburger::before { content: 'â˜°'; }
    .menu ul { list-style: none; padding: 0; }
    .menu li { margin: 20px 0; text-align: center; }
    .menu a {
      display: block; padding: 20px; font-size: 18px; font-weight: bold; color: white; text-decoration: none;
      background: rgba(0, 0, 0, 0.4); border-radius: 10px; transition: background 1s, transform 1s;
    }
    .menu a:hover, .menu a.active { background: rgba(0, 0, 0, 0.4); transform: scale(1.05); }
    .menu .desc { font-size: 14px; font-style: italic; color: #ddd; margin-top: 5px; }
    .content { flex: 1; padding: 10px; margin-left: 0; transition: margin-left 0.3s ease; text-align: center; position: relative; }
    .content.shifted { margin-left: 300px; }
    .date-time { position: absolute; top: 20px; right: 20px; font-size: 16px; color: #ffffff; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; }
    .timer { font-size: 2em; color: #ffffff; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; display: inline-block; }
    .section {
      display: none; padding: 20px; opacity: 0; transition: opacity 0.5s ease-in-out, transform 1s ease-in-out; transform: scaleX(1);
    }
    .section.active { display: block; opacity: 1; transform: scaleX(1); }
    .section.mirror-out { transform: scaleX(-1); opacity: 0; }
    .section.mirror-in { transform: scaleX(1); opacity: 1; }
    /* Welcome Section Styles */
    #welcome {
      background: rgba(0,0,0,0.4); width: 100%; min-height: 80vh; display: flex; flex-direction: column;
      align-items: center; justify-content: center; padding: 20px; position: relative;
    }
    #welcome h1 {
      font-size: 36px; color: #ffffff; text-shadow: 0 0 10px rgba(0,0,0,0.5);
      margin-bottom: 20px; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
    }
    /* Pie Chart Styles */
    #pieChartContainer { margin: 20px auto; max-width: 400px; width: 100%; }
    /* Infinite Scroll Animation */
    .scroll-container {
      width: 100%; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.4);
      padding: 10px 0; margin-bottom: 30px; height: 40px; overflow: hidden;
    }
    .scroll-text {
      display: flex; justify-content: center; align-items: center; position: relative; width: 100%; height: 100%;
    }
    .scroll-text span {
      font-size: 18px; color: #ffffff; filter: grayscale(100%); position: absolute; opacity: 0;
      animation: fade 30s infinite;
    }
    .scroll-text span:nth-child(1) { animation-delay: 0s; }
    .scroll-text span:nth-child(2) { animation-delay: 5s; }
    .scroll-text span:nth-child(3) { animation-delay: 10s; }
    .scroll-text span:nth-child(4) { animation-delay: 15s; }
    .scroll-text span:nth-child(5) { animation-delay: 20s; }
    .scroll-text span:nth-child(6) { animation-delay: 25s; }
    @keyframes fade {
      0% { opacity: 0; } 3.33% { opacity: 1; } 13.33% { opacity: 1; } 16.66% { opacity: 0; } 100% { opacity: 0; }
    }
    /* Card Hover Effect */
    .welcome-card {
      position: absolute; left: 50px; top: 50%; transform: translateY(-50%);
      width: 280px; height: 373px; background: url('pictures/tv3xJT6Ayqlx8DPn-generated_image.jpg') no-repeat center center;
      background-size: cover; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: transform 1s ease, box-shadow 1s ease; perspective: 1000px;
    }
    .welcome-card:hover {
      transform: translateY(-50%) translateZ(100px) rotateX(75deg);
      box-shadow: 10px 10px 10px rgba(153,153,153,0.5), inset -10px -10px 10px rgba(255,255,255,0.3);
    }
    /* Slideshow Styles */
    .slideshow-container {
      position: absolute; right: 50px; top: 50%; transform: translateY(-50%);
      width: 300px; height: 400px; overflow: hidden; border-radius: 15px;
    }
    .slideshow-image {
      width: 100%; height: 100%; object-fit: cover; opacity: 0.7;
      position: absolute; top: 0; left: 0; transition: opacity 1s ease-in-out;
    }
    .slideshow-image.active { opacity: 0.7; }
    .slideshow-image.inactive { opacity: 0; }
    /* Footnote Typing Effect */
    .footnote {
      position: absolute; bottom: 20px; width: 80%; text-align: center;
      font-size: 16px; color: #ffffff; overflow: hidden; white-space: nowrap;
      border-right: 2px solid #ffffff; animation: typing 5s steps(60, end) infinite, blink 0.75s step-end infinite;
    }
    @keyframes typing { from { width: 0; } to { width: 100%; } }
    @keyframes blink { from, to { border-color: transparent; } 50% { border-color: #ffffff; } }
    /* Home Section Styles */
    #home { background: rgba(139,69,19,0.6); padding: 10px; }
    #home h1, #home h2 { font-size: 24px; color: #ffebcd; margin: 10px 0; }
    #home .reading-label { font-size: 22px; margin-bottom: 10px; color: #ffebcd; font-weight: bold; }
    #home .data-box {
      background: linear-gradient(145deg, rgba(210,180,140,0.7), rgba(200,170,130,0.8));
      border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 20px;
      width: 100%; text-align: center; color: #8b4513; font-size: 24px; font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    /* Saved Records Section Styles */
    #records { background: rgba(0,0,0,0.4); padding: 10px; }
    #records h2, #records h3 { font-size: 24px; color: #e6e6fa; margin: 10px 0; }
    #records .reading-label { font-size: 22px; margin-bottom: 10px; color: #e6e6fa; font-weight: bold; }
    #records .data-box {
      background: linear-gradient(145deg, rgba(0,0,0,0.4), rgba(20,20,20,0.5));
      border: 1px solid #000; border-radius: 10px; padding: 20px; width: 100%;
      text-align: center; color: #191970; font-size: 24px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    #records p { font-size: 14px; color: #ffffff; margin: 10px 0; }
    #records .records-list li {
      background: rgba(17,17,17,0.7); padding: 15px; margin-bottom: 10px;
      border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
      font-size: 14px; color: #ffffff;
    }
    .download-symbol { color: #00ccff; font-size: 20px; text-decoration: none; transition: color 0.3s ease; }
    .download-symbol:hover { color: #00aaff; }
    .data-box .unit { font-size: 18px; vertical-align: super; margin-left: 2px; }
    /* User Dashboard Section Styles */
    #user { background: rgba(0,0,0,0.6); padding: 10px; }
    #user h2, #user h3 { font-size: 32px; color: #98fb98; margin: 10px 0; }
    #user p { font-size: 18px; color: #ffffff; margin: 10px 0; }
    .user-profile {
      background: rgba(0,0,0,0.6); padding: 20px; border-radius: 8px; max-width: 400px;
      margin: 10px auto; text-align: center;
    }
    .profile-picture { width: 100px; height: 100px; border-radius: 50%; margin: 10px auto; display: block; object-fit: cover; }
    .profile-picture-placeholder {
      width: 100px; height: 100px; border-radius: 50%; background: #ccc;
      display: flex; align-items: center; justify-content: center; margin: 10px auto; color: #666;
    }
    .upload-picture { margin: 10px 0; }
    .upload-picture input { display: none; }
    .upload-picture label {
      background: #32cd32; color: white; padding: 8px 16px; border-radius: 5px;
      cursor: pointer; font-size: 18px;
    }
    .user-profile dl { margin: 0; }
    .user-profile dt {
      font-weight: bold; font-size: 18px; color: #cccccc; margin-top: 15px;
    }
    .user-profile dd {
      font-size: 18px; color: #ffffff; margin: 5px 0 0; border-bottom: 1px solid #444; padding-bottom: 5px;
    }
    .edit-button, .save-button { background: #1e90ff; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; margin-top: 10px; }
    .delete-button { background: #ff4444; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; margin-top: 10px; }
    .footer { margin-top: 20px; font-size: 16px; color: white; text-align: center; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 999; display: none; }
    .overlay.active { display: block; }
    /* Deletion Modal Styles */
    #delete-modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8); padding: 30px; border-radius: 10px; z-index: 1100; color: #fff;
      text-align: center; width: 90%; max-width: 400px; display: none;
    }
    #delete-modal button {
      margin: 10px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
      font-size: 16px;
    }
    #delete-modal .confirm { background: #ff4444; color: #fff; }
    #delete-modal .cancel { background: #1e90ff; color: #fff; }
    @media (max-width: 768px) {
      .content, #home, #records, #user { padding: 5px; }
      .data-container, .user-profile { margin: 5px auto; }
      .welcome-card, .slideshow-container { position: static; transform: none; margin: 20px auto; }
      .footnote { position: static; margin-top: 20px; }
    }
  </style>
</head>
<body class="login-active">
  <!-- Login Section -->
  <div class="login-section active" id="login-section">
    <div class="login-box">
      <div class="login-header">
        <span class="heart">â™¥</span>
        <h2>IRRIGATION SCHEME LOGIN</h2>
      </div>
      <div class="description">
        <p>Monitor and manage your irrigation system with ease.</p>
      </div>
      <!-- Login Form -->
      <form id="login-form">
        <div class="form-group">
          <label for="irrigator-id">Username</label>
          <input type="text" id="irrigator-id" name="irrigator-id" placeholder="Enter your Username" required>
        </div>
        <div class="form-group">
          <label for="access-code">Access Code</label>
          <input type="password" id="access-code" name="access-code" placeholder="Enter your Access Code" required>
          <span class="toggle-password" id="toggle-password-login">Show</span>
        </div>
        <div class="buttons">
          <button type="submit" class="signin-button">ACCESS SYSTEM</button>
          <button type="button" class="signup-button" id="toggle-register">SIGN UP</button>
        </div>
        <!-- Google Sign-In Button -->
        <div class="buttons">
          <button type="button" class="google-button" id="google-signin">
            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo" class="google-icon">
            Sign in with Google
          </button>
        </div>
        <div class="links">
          <a href="reset-password.html">FORGOT ACCESS CODE</a>
          <a href="#">REGISTER IRRIGATOR</a>
        </div>
        <div class="error-message" id="error-message"></div>
      </form>
      <!-- Registration Form (hidden by default) -->
      <form id="register-form" class="hidden">
        <div class="login-header">
          <span class="heart">â™¥</span>
          <h2>REGISTER NEW ACCOUNT</h2>
        </div>
        <div class="form-group">
          <label for="reg-username">Username</label>
          <input type="text" id="reg-username" name="username" placeholder="Add Username" required>
        </div>
        <div class="form-group">
          <label for="reg-email">Email</label>
          <input type="email" id="reg-email" name="email" placeholder="Add Email" required>
        </div>
        <div class="form-group">
          <label for="reg-password">Password</label>
          <input type="password" id="reg-password" name="password" placeholder="Enter Password" required>
          <span class="toggle-password" id="toggle-password-reg">Show</span>
        </div>
        <!-- New: Role Selection -->
        <div class="form-group">
          <label for="reg-role">Select Role</label>
          <select id="reg-role" name="role" required>
            <option value="user" selected>User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <!-- Secret Key field (only shown if admin selected) -->
        <div class="form-group hidden" id="secret-key-group">
          <label for="reg-secret-key">Secret Key (for Admin)</label>
          <input type="text" id="reg-secret-key" name="secret_key" placeholder="Enter secret key">
        </div>
        <div class="buttons">
          <button type="submit" class="signin-button">REGISTER</button>
        </div>
        <div class="form-toggle" id="toggle-login">Already have an account? Login</div>
        <div class="error-message" id="reg-error-message"></div>
      </form>
    </div>
  </div>

  <!-- Dashboard Section -->
  <div class="dashboard-section" id="dashboard-section">
    <div class="hamburger" id="hamburger"></div>
    <div class="overlay" id="overlay"></div>
    <nav class="sidebar" id="sidebar">
      <div class="menu">
        <ul>
          <li>
            <a href="#welcome" class="active">Welcome</a>
            <div class="desc">Explore the Irrigation Scheme</div>
          </li>
          <li>
            <a href="#home">Home</a>
            <div class="desc">Monitor your farmâ€™s health</div>
          </li>
          <li>
            <a href="#records">Saved Records</a>
            <div class="desc">Access past irrigation data</div>
          </li>
          <li>
            <a href="#user">User Dashboard</a>
            <div class="desc">Manage your profile data</div>
          </li>
        </ul>
      </div>
    </nav>
    <div class="content" id="content">
      <div class="date-time" id="date-time"></div>
      <!-- Welcome Section -->
      <div id="welcome" class="section active">
        <h1>IRRIGATION MONITORING SCHEME</h1>
        <div class="scroll-container">
          <div class="scroll-text">
            <span>Temperature</span>
            <span>Humidity</span>
            <span>Soil Moisture</span>
            <span>Soil pH</span>
            <span>Light Intensity</span>
            <span>Anomaly</span>
          </div>
        </div>
        <div class="welcome-card"></div>
        <div class="slideshow-container">
          <img src="pictures/pexels-tara-winstead-7723354.jpg" class="slideshow-image active" alt="Slideshow Image 1">
          <img src="pictures/pexels-dakota-gillette-18281-89749.jpg" class="slideshow-image inactive" alt="Slideshow Image 2">
          <img src="pictures/pexels-tdcat-347729.jpg" class="slideshow-image inactive" alt="Slideshow Image 3">
          <img src="pictures/pexels-suleyman-sahan-1365370-2684805.jpg" class="slideshow-image inactive" alt="Slideshow Image 4">
        </div>
        <div class="footnote">
          Welcome to the Irrigation Monitoring Scheme, where technology meets agriculture to ensure optimal growth and sustainability.
        </div>
      </div>
      <!-- Home Section -->
      <div id="home" class="section">
        <h1>IRRIGATION MONITORING SCHEME</h1>
        <div class="data-container">
          <div class="reading">
            <div class="reading-label">Temperature</div>
            <div class="data-box" id="temperature">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Humidity</div>
            <div class="data-box" id="humidity">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Soil Moisture</div>
            <div class="data-box" id="soil-moisture">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Soil pH</div>
            <div class="data-box" id="soil-ph">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Light Intensity</div>
            <div class="data-box" id="light-intensity">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Anomaly</div>
            <div class="data-box" id="anomaly">Loading...</div>
          </div>
        </div>
        <!-- Pie Chart Container -->
        <div id="pieChartContainer">
          <canvas id="pieChart"></canvas>
        </div>
        <div class="footer">Your farm, your control. Stay informed with real-time irrigation monitoring.</div>
      </div>
      <!-- Saved Records Section -->
      <div id="records" class="section">
        <h2>Saved Records</h2>
        <p>Here you can access and download your saved records for further analysis.</p>
        <div class="data-container" id="records-data">
          <div class="reading">
            <div class="reading-label">Temperature</div>
            <div class="data-box" id="records-temperature">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Humidity</div>
            <div class="data-box" id="records-humidity">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Soil Moisture</div>
            <div class="data-box" id="records-soil-moisture">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Soil pH</div>
            <div class="data-box" id="records-soil-ph">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Light Intensity</div>
            <div class="data-box" id="records-light-intensity">Loading...</div>
          </div>
          <div class="reading">
            <div class="reading-label">Anomaly</div>
            <div class="data-box" id="records-anomaly">Loading...</div>
          </div>
        </div>
        <div class="timer" id="records-timer">Next update in: 5.000s</div>
        <h3>Downloadable Records</h3>
        <ul class="records-list" id="records-list">
          <!-- Records will be dynamically populated here -->
        </ul>
      </div>
      <!-- User Dashboard Section -->
      <div id="user" class="section">
        <h2>User Dashboard</h2>
        <p>Manage your profile, settings, and view your verified account details.</p>
        <div class="user-profile">
          <div id="profile-picture-container">
            <img id="profile-picture" class="profile-picture" alt="Profile Picture" style="display: none;">
            <div id="profile-picture-placeholder" class="profile-picture-placeholder">No Image</div>
          </div>
          <div class="upload-picture">
            <input type="file" id="profile-picture-input" accept="image/*">
            <label for="profile-picture-input">Upload Picture</label>
          </div>
          <dl id="user-details-list">
            <dt>Username</dt>
            <dd id="username" contenteditable="false"></dd>
            <dt>Email</dt>
            <dd id="email" contenteditable="false"></dd>
            <dt>Role</dt>
            <dd id="role" contenteditable="false"></dd>
          </dl>
          <button class="edit-button" id="edit-profile">Edit Profile</button>
          <button class="save-button" id="save-profile" style="display: none;">Save Changes</button>
          <button class="delete-button" id="delete-account">Delete Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Deletion Modal -->
  <div id="delete-modal">
    <h3>Are you sure you want to delete your account?</h3>
    <p>This action cannot be undone.</p>
    <button class="confirm" id="confirm-delete">Yes, Delete My Account</button>
    <button class="cancel" id="cancel-delete">No, Keep My Account</button>
  </div>

  <!-- Demo Verification Section (for testing email verification) -->
  <div id="demo-verification" class="hidden" style="padding:20px; background:#222; color:#fff; text-align:center;">
    <h3>Email Verification</h3>
    <p>Click the link below to verify your email:</p>
    <a href="#" id="demo-verify-link" style="color:#00ccff; text-decoration:underline;">Verify Email</a>
  </div>

  <script>
    // --- Elements ---
    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const errorMessage = document.getElementById('error-message');
    const regErrorMessage = document.getElementById('reg-error-message');
    const toggleRegister = document.getElementById('toggle-register');
    const toggleLogin = document.getElementById('toggle-login');
    const googleSigninBtn = document.getElementById('google-signin');
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const content = document.getElementById('content');
    const recordsList = document.getElementById('records-list');
    const recordsTimer = document.getElementById('records-timer');
    const dateTimeDisplay = document.getElementById('date-time');
    const deleteAccountBtn = document.getElementById('delete-account');
    // Deletion Modal Elements
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    // Registration new fields for role and secret key
    const regRole = document.getElementById('reg-role');
    const secretKeyGroup = document.getElementById('secret-key-group');
    const regSecretKey = document.getElementById('reg-secret-key');
    // User Profile Elements
    const profilePicture = document.getElementById('profile-picture');
    const profilePicturePlaceholder = document.getElementById('profile-picture-placeholder');
    const profilePictureInput = document.getElementById('profile-picture-input');
    const usernameDisplay = document.getElementById('username');
    const emailDisplay = document.getElementById('email');
    const roleDisplay = document.getElementById('role');
    const editProfileButton = document.getElementById('edit-profile');
    const saveProfileButton = document.getElementById('save-profile');
    // Password Toggle Elements
    const togglePasswordLogin = document.getElementById('toggle-password-login');
    const togglePasswordReg = document.getElementById('toggle-password-reg');
    // Demo Verification
    const demoVerification = document.getElementById('demo-verification');
    const demoVerifyLink = document.getElementById('demo-verify-link');

    // --- Track Login State ---
    let isLoggedIn = false;
    const isOnlineMode = window.location.protocol === 'http:' || window.location.protocol === 'https:';
    let timerStart = null;
    let lastData = null;
    let timerInterval = null;
    // Default user profile
    let userProfile = { username: 'admin', email: 'admin@example.com', role: 'Administrator', picture: null };

    function loadUserProfile() {
      const savedProfile = localStorage.getItem('userProfile');
      if (savedProfile) { userProfile = JSON.parse(savedProfile); }
      updateUserProfileDisplay();
    }
    function updateUserProfileDisplay() {
      usernameDisplay.textContent = userProfile.username;
      emailDisplay.textContent = userProfile.email;
      roleDisplay.textContent = userProfile.role;
      if (userProfile.picture) {
        profilePicture.src = userProfile.picture;
        profilePicture.style.display = 'block';
        profilePicturePlaceholder.style.display = 'none';
      } else {
        profilePicture.style.display = 'none';
        profilePicturePlaceholder.style.display = 'flex';
      }
    }
    function saveUserProfile() {
      localStorage.setItem('userProfile', JSON.stringify(userProfile));
      updateUserProfileDisplay();
    }
    profilePictureInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          userProfile.picture = event.target.result;
          saveUserProfile();
        };
        reader.readAsDataURL(file);
      }
    });
    editProfileButton.addEventListener('click', () => {
      usernameDisplay.contentEditable = true;
      emailDisplay.contentEditable = true;
      roleDisplay.contentEditable = true;
      usernameDisplay.style.background = '#333';
      emailDisplay.style.background = '#333';
      roleDisplay.style.background = '#333';
      editProfileButton.style.display = 'none';
      saveProfileButton.style.display = 'block';
    });
    saveProfileButton.addEventListener('click', async () => {
      userProfile.username = usernameDisplay.textContent;
      userProfile.email = emailDisplay.textContent;
      userProfile.role = roleDisplay.textContent;
      usernameDisplay.contentEditable = false;
      emailDisplay.contentEditable = false;
      roleDisplay.contentEditable = false;
      usernameDisplay.style.background = 'none';
      emailDisplay.style.background = 'none';
      roleDisplay.style.background = 'none';
      editProfileButton.style.display = 'block';
      saveProfileButton.style.display = 'none';
      saveUserProfile();
      try {
        const response = await fetch('/api/updateuser', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username: userProfile.username, email: userProfile.email})
        });
        const result = await response.json();
        if (!response.ok) { alert(result.message); }
      } catch (error) { alert("Error updating user. Please try again."); }
    });
    function updateDateTime() {
      const now = new Date();
      const options = {year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'};
      dateTimeDisplay.textContent = now.toLocaleDateString('en-US', options);
    }
    window.addEventListener('load', () => {
      isLoggedIn = false;
      loginSection.classList.add('active');
      dashboardSection.classList.remove('active');
      document.body.classList.add('login-active');
      document.body.classList.remove('dashboard-active');
      document.body.style.backgroundImage = "url('pictures/pexels-souvenirpixels-417074.jpg')";
      loadUserProfile();
      updateDateTime();
      setInterval(updateDateTime, 1000);
    });
    function showDashboard() {
      loginSection.classList.remove('active');
      dashboardSection.classList.add('active');
      document.body.classList.remove('login-active');
      document.body.classList.add('dashboard-active');
      document.body.style.backgroundImage = "url('pictures/pexels-dakota-gillette-18281-89749.jpg')";
      startDataUpdates();
      startRecordsUpdates();
      startTimer();
      startSlideshow();
    }
    // --- Registration: Show secret key field when admin selected ---
    regRole.addEventListener('change', () => {
      if (regRole.value === 'admin') {
        secretKeyGroup.classList.remove('hidden');
      } else {
        secretKeyGroup.classList.add('hidden');
        regSecretKey.value = '';
      }
    });
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const username = document.getElementById('irrigator-id').value;
      const password = document.getElementById('access-code').value;
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username, password})
        });
        const result = await response.json();
        if (response.ok) {
          isLoggedIn = true;
          showDashboard();
        } else {
          errorMessage.textContent = result.message;
        }
      } catch (error) {
        errorMessage.textContent = 'An error occurred. Please try again.';
      }
    });
    registerForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const username = document.getElementById('reg-username').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;
      const role = document.getElementById('reg-role').value;
      const secret_key = regSecretKey.value;
      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username, email, password, role, secret_key})
        });
        const result = await response.json();
        if (response.ok) {
          alert('Registration successful! Please check your email for the verification link.');
          // For demo, show the verification link:
          demoVerification.classList.remove('hidden');
          demoVerifyLink.href = result.verification_link;
          demoVerifyLink.textContent = result.verification_link;
          registerForm.classList.add('hidden');
          loginForm.classList.remove('hidden');
        } else {
          regErrorMessage.textContent = result.message;
        }
      } catch (error) {
        regErrorMessage.textContent = 'An error occurred. Please try again.';
      }
    });
    toggleRegister.addEventListener('click', () => {
      loginForm.classList.add('hidden');
      registerForm.classList.remove('hidden');
    });
    toggleLogin && toggleLogin.addEventListener('click', () => {
      registerForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
    });
    googleSigninBtn.addEventListener('click', () => {
      window.location.href = '/api/google';
    });
    // --- Delete Account: Open modal window ---
    deleteAccountBtn.addEventListener('click', () => {
      deleteModal.style.display = 'block';
    });
    confirmDeleteBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/deleteaccount', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username: userProfile.username, password: prompt("Please enter your password to confirm deletion:")})
        });
        const result = await response.json();
        if (response.ok) {
          alert(result.message);
          window.location.reload();
        } else {
          alert(result.message);
          deleteModal.style.display = 'none';
        }
      } catch (error) {
        alert("Error deleting account. Please try again.");
        deleteModal.style.display = 'none';
      }
    });
    cancelDeleteBtn.addEventListener('click', () => {
      deleteModal.style.display = 'none';
    });
    document.querySelectorAll('.links a')[0].addEventListener('click', function(e) {
      e.preventDefault();
      window.location.href = 'reset-password.html';
    });
    hamburger.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
      content.classList.toggle('shifted');
    });
    overlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
      content.classList.remove('shifted');
    });
    let currentSection = 'welcome';
    document.querySelectorAll('.menu a').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const target = this.getAttribute('href').substring(1);
        const currentSectionElement = document.getElementById(currentSection);
        const targetSectionElement = document.getElementById(target);
        currentSectionElement.classList.add('mirror-out');
        setTimeout(() => {
          document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
          targetSectionElement.classList.add('active', 'mirror-in');
          if (target === 'welcome') {
            document.body.style.backgroundImage = "url('pictures/pexels-dakota-gillette-18281-89749.jpg')";
          } else if (target === 'home') {
            document.body.style.backgroundImage = "url('pictures/pexels-suleyman-sahan-1365370-2684805.jpg')";
          } else if (target === 'records') {
            document.body.style.backgroundImage = "url('pictures/pexels-souvenirpixels-417074.jpg')";
          } else if (target === 'user') {
            document.body.style.backgroundImage = "url('pictures/pexels-tdcat-347729.jpg')";
          }
          currentSection = target;
        }, 500);
        document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
        this.classList.add('active');
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        content.classList.remove('shifted');
      });
    });
    // --- Data Updates (Fetch from backend) ---
    async function updateReadings() {
      if (!isLoggedIn) return;
      try {
        const response = await fetch('/api/irrigation-data');
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        const dataString = JSON.stringify(data);
        if (lastData !== dataString) {
          lastData = dataString;
          resetTimer();
        }
        document.getElementById('temperature').innerHTML = `${data.temperature}<span class="unit">Â°C</span>`;
        document.getElementById('humidity').innerHTML = `${data.humidity}<span class="unit">%</span>`;
        document.getElementById('soil-moisture').innerHTML = `${data.soilMoisture}<span class="unit">%</span>`;
        document.getElementById('soil-ph').textContent = data.soilPH;
        document.getElementById('light-intensity').innerHTML = `${data.lightIntensity}<span class="unit"> lux</span>`;
        document.getElementById('anomaly').textContent = data.anomaly;
        document.getElementById('records-temperature').innerHTML = `${data.temperature}<span class="unit">Â°C</span>`;
        document.getElementById('records-humidity').innerHTML = `${data.humidity}<span class="unit">%</span>`;
        document.getElementById('records-soil-moisture').innerHTML = `${data.soilMoisture}<span class="unit">%</span>`;
        document.getElementById('records-soil-ph').textContent = data.soilPH;
        document.getElementById('records-light-intensity').innerHTML = `${data.lightIntensity}<span class="unit"> lux</span>`;
        document.getElementById('records-anomaly').textContent = data.anomaly;
        updatePieChart(data);
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }
    async function updateRecordsList() {
      if (!isLoggedIn) return;
      try {
        const response = await fetch('/api/records');
        if (!response.ok) throw new Error('Network response was not ok');
        const records = await response.json();
        if (records.length === 0) {
          recordsList.innerHTML = '<li>No records available.</li>';
        } else {
          recordsList.innerHTML = records.map(record => {
            const timestamp = record.replace('record_', '').replace('.docx', '').replace(/_/g, ' ');
            return `<li>Record from ${timestamp}: <a href="records/${record}" download class="download-symbol">â¬‡</a></li>`;
          }).join('');
        }
      } catch (error) {
        console.error('Error fetching records:', error);
        recordsList.innerHTML = '<li>Error loading records.</li>';
      }
    }
    function startDataUpdates() {
      updateReadings();
      setInterval(updateReadings, 10000); // update every 10 seconds from backend
    }
    function startRecordsUpdates() {
      updateRecordsList();
      setInterval(updateRecordsList, 10000);
    }
    function startTimer() {
      timerStart = performance.now();
      timerInterval = setInterval(() => {
        const elapsed = (performance.now() - timerStart) / 1000;
        const remaining = 10 - (elapsed % 10);
        const seconds = Math.floor(remaining);
        const microseconds = Math.floor((remaining - seconds) * 1000);
        recordsTimer.textContent = `Next update in: ${seconds}.${microseconds.toString().padStart(3, '0')}s`;
      }, 10);
    }
    function resetTimer() {
      timerStart = performance.now();
      recordsTimer.textContent = 'Next update in: 10.000s';
    }
    function startSlideshow() {
      const images = document.querySelectorAll('.slideshow-image');
      let currentIndex = 0;
      function showNextImage() {
        images[currentIndex].classList.remove('active');
        images[currentIndex].classList.add('inactive');
        currentIndex = (currentIndex + 1) % images.length;
        images[currentIndex].classList.remove('inactive');
        images[currentIndex].classList.add('active');
      }
      setInterval(showNextImage, 5000);
    }
    function updatePieChart(data) {
      const ctx = document.getElementById('pieChart').getContext('2d');
      const values = [
        parseFloat(data.temperature),
        parseFloat(data.humidity),
        parseFloat(data.soilMoisture),
        parseFloat(data.soilPH),
        parseFloat(data.lightIntensity)
      ];
      if(window.myPieChart) {
        window.myPieChart.data.datasets[0].data = values;
        window.myPieChart.update();
      } else {
        window.myPieChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Temperature', 'Humidity', 'Soil Moisture', 'Soil pH', 'Light Intensity'],
            datasets: [{
              data: values,
              backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#8bc34a', '#9c27b0']
            }]
          },
          options: { responsive: true }
        });
      }
    }
    togglePasswordLogin.addEventListener('click', function() {
      const passField = document.getElementById('access-code');
      if (passField.type === 'password') { passField.type = 'text'; this.textContent = 'Hide'; }
      else { passField.type = 'password'; this.textContent = 'Show'; }
    });
    togglePasswordReg.addEventListener('click', function() {
      const passField = document.getElementById('reg-password');
      if (passField.type === 'password') { passField.type = 'text'; this.textContent = 'Hide'; }
      else { passField.type = 'password'; this.textContent = 'Show'; }
    });
    // Start periodic updates
    startDataUpdates();
    startRecordsUpdates();
    startTimer();
    startSlideshow();
  </script>
</body>
</html>
